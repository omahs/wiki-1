<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developing-contracts/distributed_transactions">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Ensuring reliability in asynс programming | Gear Documentation Portal</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://wiki.gear-tech.io/docs/developing-contracts/distributed_transactions"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ensuring reliability in asynс programming | Gear Documentation Portal"><meta data-rh="true" name="description" content="One of the key features of the Gear Protocol is its use of the Actor model for message-passing communication. The Actor model framework enables asynchronous messaging and parallel computation, which  drastically improves the achievable speed and scalability of dApps. In the Actor model, programs do not share state and instead communicate with each other through messages. If a program sends an asynchronous message to another program, it has to wait for a reply from the other program before it can proceed with the next operation."><meta data-rh="true" property="og:description" content="One of the key features of the Gear Protocol is its use of the Actor model for message-passing communication. The Actor model framework enables asynchronous messaging and parallel computation, which  drastically improves the achievable speed and scalability of dApps. In the Actor model, programs do not share state and instead communicate with each other through messages. If a program sends an asynchronous message to another program, it has to wait for a reply from the other program before it can proceed with the next operation."><link data-rh="true" rel="icon" href="/img/favicon-32x32.png"><link data-rh="true" rel="canonical" href="https://wiki.gear-tech.io/docs/developing-contracts/distributed_transactions"><link data-rh="true" rel="alternate" href="https://wiki.gear-tech.io/docs/developing-contracts/distributed_transactions" hreflang="en"><link data-rh="true" rel="alternate" href="https://wiki.gear-tech.io/zh-cn/docs/developing-contracts/distributed_transactions" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://wiki.gear-tech.io/docs/developing-contracts/distributed_transactions" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://OI5YH8L74V-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-213824102-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


<link rel="search" type="application/opensearchdescription+xml" title="Gear Documentation Portal" href="/opensearch.xml">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.64344df8.css">
<link rel="preload" href="/assets/js/runtime~main.6ab75420.js" as="script">
<link rel="preload" href="/assets/js/main.afedc896.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-black.svg" alt="Gear documentation portal" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo-white.svg" alt="Gear documentation portal" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Gear Wiki</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://www.vara-network.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">VARA<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://www.gear-tech.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Gear-tech.io<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/gear-tech/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Contribute<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/developing-contracts/distributed_transactions" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-cn/docs/developing-contracts/distributed_transactions" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-cn">简体中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Welcome!</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/gear/why">Intro to Gear Protocol</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/getting-started-in-5-minutes">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/node/setting-up">Gear Node</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/developing-contracts/executable-functions">Developing Smart Contracts</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/executable-functions">Executable Functions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/gstd">Gear Library</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/mailbox">Mailbox</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/state">State Functions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/metadata">Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/codec">Data Encoding/Decoding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/interactions-between-programs">Asynchronous Programming</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/create">Create Program</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/gas-reservation">Gas Reservation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/delayed-messages">Delayed Messages</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developing-contracts/distributed_transactions">Consistency and Reliability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/system-signals">System Signals</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/deploy">Upload Program</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/testing">Program Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/testing-gtest">Testing with gtest</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing-contracts/testing-gclient">Testing with gclient</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/examples/prerequisites">Smart Contract Examples</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/idea/idea-overview">Gear IDEA</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/api/getting-started">JSON-RPC API</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/general/web3">General topics</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/gear-networks/vara-intro">Gear-based Networks</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Developing Smart Contracts</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Consistency and Reliability</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Ensuring reliability in asynс programming</h1><p>One of the key features of the Gear Protocol is its use of the Actor model for message-passing communication. The Actor model framework enables asynchronous messaging and parallel computation, which  drastically improves the achievable speed and scalability of dApps. In the Actor model, programs do not share state and instead communicate with each other through messages. If a program sends an asynchronous message to another program, it has to wait for a reply from the other program before it can proceed with the next operation.</p><p>When a program interacts with another program, the transaction becomes &quot;distributed.&quot; A distributed transaction is a set of operations performed across multiple databases or, in the case of the Gear Protocol, across multiple actors with their own states. Distributed transactions must possess these properties:</p><ul><li>Atomicity - all data changes are treated as if they were a single operation. That is, either all of the modifications are made, or none of them are made;</li><li>Consistency - this property implies that when a transaction begins and ends, the state of data is consistent.</li></ul><p>For example, transactions on the Ethereum blockchain are atomic, meaning that if a transaction fails due to an error, all of its effects on the global state are rolled back as if the transaction never occurred. Many blockchain applications rely on the atomicity of transactions, but this can be a problem when building asynchronous applications using the programming paradigm used on Ethereum, as you may encounter the problem of not being able to recover program state after a failed transaction.</p><p>Consider a simple token exchange where a user wants to swap tokens A for tokens B in a liquidity pool. The swap contract would send a message to the token A contract and a message to the token B contract. If one of these messages succeeds and the other fails for some reason, the state of the token A contract would be changed while the state of the token B contract would remain unchanged. This can cause inconsistencies in the state of the data and make it difficult to recover from failed transactions. As a result, it is important to consider different programming paradigms for implementing distributed transactions.</p><p>Let&#x27;s look at different programming methods using the example of a token exchange.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="splitting-a-token-swap-transaction-into-3-separate-transactions">Splitting a token swap transaction into 3 separate transactions<a href="#splitting-a-token-swap-transaction-into-3-separate-transactions" class="hash-link" aria-label="Direct link to Splitting a token swap transaction into 3 separate transactions" title="Direct link to Splitting a token swap transaction into 3 separate transactions">​</a></h2><p>Consider the following situation: we have a liquidity pool of token A and token B, and also a user who wants to exchange his tokens A for tokens B.</p><p><code>Step 1</code> : A user sends a <code>MakeOrder</code> message to the swap contract. During that transaction the contract sends a message to the fungible token contract. The result of executing this message can be a success or a failure. The worst case scenario is having a lack of gas when processing a message in the token contract or in the subsequent execution of the swap contract. However, since the token contract supports idempotency, the user can simply restart the transaction and complete it.</p><p><img loading="lazy" alt="img alt" src="/assets/images/1.step1-bcde9c4b053ed8ce9dad52f33f3c8e50.png#gh-light-mode-only" width="2197" height="580" class="img_ev3q">
<img loading="lazy" alt="img alt" src="/assets/images/1.step1-dark-f14712c305ad5dcb25e26bfa5d6e6e08.png#gh-dark-mode-only" width="2197" height="580" class="img_ev3q"></p><p><code>Step 2</code>:  A user sends an <code>ExecuteOrder</code> message to the swap contract. The swap contract just calculates the amount of tokens a user will receive and saves the new state of the liquidity poll.</p><p><img loading="lazy" alt="img alt" src="/assets/images/1.step2-d647dfa5fadd512f52fc89f9c6183a3b.png#gh-light-mode-only" width="1387" height="466" class="img_ev3q">
<img loading="lazy" alt="img alt" src="/assets/images/1.step2-dark-9d91ef78b9a0c07d2409162154a5c139.png#gh-dark-mode-only" width="1387" height="466" class="img_ev3q"></p><p><code>Step 3</code>:  A user sends a <code>Withdraw</code> message to the swap contract and receives tokens B. The situation here is the same as in the first step.</p><p><img loading="lazy" alt="img alt" src="/assets/images/1.step3-0b364770e9107733810a7f8c90cf56d8.png#gh-light-mode-only" width="2206" height="550" class="img_ev3q">
<img loading="lazy" alt="img alt" src="/assets/images/1.step3-dark-5ae16fa99ce1ce4edcbee7559f81805e.png#gh-dark-mode-only" width="2206" height="550" class="img_ev3q"></p><p>It is possible to execute a swap in one transaction. To resolve the problem of atomicity we can use the following patterns here:</p><ul><li><code>2 PC - 2 Phase Commit protocol</code> (And also its extension - 3 phase commit protocol);</li><li><code>Saga Pattern</code>.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="two-phase-commit-protocol">Two phase commit protocol<a href="#two-phase-commit-protocol" class="hash-link" aria-label="Direct link to Two phase commit protocol" title="Direct link to Two phase commit protocol">​</a></h2><p><strong>Theory</strong>:
We have a coordinator that sends messages to participants. The <code>two-phase commit protocol</code> has two parts: the <code>prepare</code> phase and the <code>commit</code> phase.</p><p><strong>Preparation phase:</strong>
During the preparation phase, the coordinator and participants perform the following dialog:</p><ul><li><code>Coordinator</code>:
The coordinator directs each participant database server to prepare to commit the transaction.</li><li><code>Participants</code>:
Every participant notifies the coordinator whether it can commit to its transaction branch.</li><li><code>Coordinator</code>:
The coordinator, based on the response from each participant, decides whether to commit or roll back the transaction. It decides to commit only if all participants indicate that they can commit to their transaction branches. If any participant indicates that it is not ready to commit to its transaction branch (or if it does not respond), the coordinator decides to end the global transaction.</li></ul><p><strong>Commit phase:</strong></p><p>During the commit phase, the coordinator and participants perform the following dialog:</p><ul><li><code>Coordinator</code>:
The coordinator writes the commit record or rollback record to the coordinator&#x27;s logical log and then directs each participant to either commit or roll back the transaction.</li><li><code>Participants</code>:
If the coordinator issued a commit message, the participants commit the transaction by writing the commit record to the logical log and then sending a message to the coordinator acknowledging that the transaction was committed. If the coordinator issued a rollback message, the participants roll back the transaction but do not send an acknowledgment to the coordinator.</li><li><code>Coordinator</code>:
If the coordinator issues a message to commit the transaction, it waits to receive acknowledgment from each participant before it ends the global transaction. If the coordinator issued a message to roll back the transaction, it does not wait for acknowledgments from the participants.</li></ul><p>Let&#x27;s see how it can be used in the example of a token swap contract. We consider the following situation: the account wants to exchange his tokens (let’s call it tokenA) for other tokens (tokenB) using the liquidity pool in the swap contract.</p><p>In that case the swap contract is a coordinator contract and tokens contracts are participants.</p><p>The swap contract makes the following steps:</p><p><strong>Prepare phase</strong></p><ul><li><code>Swap contract:</code>
Swap contract sends the messages to token contracts to prepare transfer tokens (Messages can be sent in parallel). In fact, token contracts must lock funds at this stage.</li><li><code>Token contract</code>:
Token contracts make all necessary checks, and in case of success, lock funds and reply to the swap contract that they are ready to make a transaction.</li><li><code>Swap contract</code>:
Swap contract handles the messages from the token contracts and decides whether to commit or abort the global transaction.
receives tokens B. The situation here is the same as in the first step.</li></ul><p><img loading="lazy" alt="img alt" src="/assets/images/2.prepare-5fe68cdcee4ff2fc83f296f1a20288fe.png#gh-light-mode-only" width="1603" height="853" class="img_ev3q">
<img loading="lazy" alt="img alt" src="/assets/images/2.prepare-dark-c6fe206f1bb984eed7fff04b8fa8bc6c.png#gh-dark-mode-only" width="1603" height="853" class="img_ev3q"></p><p><strong>Commit phase</strong></p><ul><li><code>Swap contract</code>:
If token contracts confirm their readiness to execute the transaction, the swap contract sends them a message to commit the state. Otherwise, the swap contract tells them to abort the transaction.</li><li><code>Token contract</code>:
Token contracts finally change their state and send replies to the swap contract;</li><li>`Swap contracts:
Swap contract handles the messages from the token contracts and saves the result about transaction execution.</li></ul><p><img loading="lazy" alt="img alt" src="/assets/images/2.commit-ab5ebd7f46cf762e1ba5c4cdcd1de2c7.png#gh-light-mode-only" width="1516" height="853" class="img_ev3q">
<img loading="lazy" alt="img alt" src="/assets/images/2.commit-dark-8b62864524bcc649489526d835971a73.png#gh-dark-mode-only" width="1516" height="853" class="img_ev3q"></p><p>Of course, all that workflow handles the case when the gas runs out during the message execution.</p><p><code>Pros:</code></p><ul><li>Messages can be sent in parallel;</li><li>If cases with a lack of gas are taken into account, then the data consistency is achieved.</li></ul><p><code>Cons:</code></p><ul><li>The participants have to wait for the message from the coordinator, they can’t commit or abort themselves;</li><li>The coordinator plays an important role: if it fails to send the message then all participants go to the blocked state (in our example: the funds in token contracts are blocked).</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="three-phase-commit-protocol">Three phase commit protocol.<a href="#three-phase-commit-protocol" class="hash-link" aria-label="Direct link to Three phase commit protocol." title="Direct link to Three phase commit protocol.">​</a></h2><p><strong>Theory</strong>: It is similar to two-phase commit protocol but it tries to solve the problems with blocking the state of participants and to give the participants the opportunity to recover their states themselves.</p><p><strong>Prepare phase:</strong>
The same steps of two phase commit protocol are followed here:</p><ul><li><code>Coordinator</code>:
The coordinator sends a prepare message to all participants and waits for replies;</li><li><code>Participants</code>:
If the participants are ready to commit a transaction they send the ready message, otherwise they send no message to the coordinator.</li><li><code>Coordinator</code>:
Based on replies the coordinator decides either to go to the next state or not. If any of the participants respond with no message or if any of the participants fails to respond within a defined time, the coordinator sends an abort message to every participant.  It is important to highlight the differences from two phase commit protocol:<ul><li>The coordinator limits the response time from the participant. We can implement this by sending a message with an indicated amount of gas or indicated number of blocks the coordinator is ready to wait;</li><li>If the coordinator fails at this state, then the participants are able to abort the transaction (i.e. unlock their state) using delayed messages. So, in that phase, the timeout cases abort.</li></ul></li></ul><p><strong>Prepare-to-commit phase:</strong></p><ul><li><code>Coordinator</code>:
The coordinator sends a prepare-to-commit message to all participants and gets acknowledgements from everyone;</li><li><code>Participants</code>:
Receiving a prepare-to-commit message, a participant knows that the unanimous decision was to commit. As was already mentioned in the prepare phase, if a participant fails to receive this message in time, then it aborts. However, if a participant receives an abort message then it can immediately abort the transaction.
The possible problem: the coordinator fails during sending a prepare-to-commit to participants. So some participants are in phase 2, others are in phase 1. It&#x27;s a disaster because the first group will commit, the second group will abort in case of timeout.
So we have to make sure that If one of the participants has received a precommit message, they can all commit. If the coordinator falls, any of the participants, being at the second stage, can become the coordinator itself and continue the transaction.</li><li><code>Coordinator</code>:
Having received acknowledgements from all the participants, the coordinator goes to the next phase.</li></ul><p>The three-phase commit protocol accomplishes two things:</p><ol><li>Enables use of a <code>recovery coordinator</code> (it can be a coordinator itself that starts a new transaction, or a participant). If a coordinator died, a recovery coordinator can query a participant.<ul><li>If the participant is found to be in phase 2, that means that every participant has completed phase 1 and voted on the outcome. The completion of phase 1 is guaranteed. It is possible that some participants may have received commit requests (phase 3). The recovery coordinator can safely resume at phase 2.</li><li>If the participant was in phase 1, that means NO participant has started commits or aborts. The protocol can start at the beginning.</li><li>If the participant was in phase 3, the coordinator can continue in phase 3 – and make sure everyone gets the commit/abort request</li></ul></li><li>Every phase can now time out – there is no indefinite wait as in the two-phase commit protocol.<ul><li><code>Phase 1</code>:
Participant aborts if it doesn’t hear from a coordinator in time;
Coordinator sends aborts to all if it doesn’t hear from any participant.</li><li><code>Phase 2</code>:
If a participant times out waiting for a coordinator, elect a new coordinator.</li></ul></li></ol><p>Let’s get back to our swap contract.</p><p><strong>Preparation phase</strong>:
The following cases are possible:</p><ul><li>all token contracts receive the message;</li><li>the swap contract fails to wait for response from any token contract</li><li>the swap contract fails itself.</li></ul><p>In the case of a fall, if a transaction isn&#x27;t restarted, the swap contract will not move to the second phase and the token contracts will unlock their state using delayed messages.</p><p><img loading="lazy" alt="img alt" src="/assets/images/3.prepare-5b72776ee099a517f4b7a33ac0d84bc5.png#gh-light-mode-only" width="1441" height="1243" class="img_ev3q">
<img loading="lazy" alt="img alt" src="/assets/images/3.prepare-dark-ea97c261699a829c5f86d1d128543253.png#gh-dark-mode-only" width="1441" height="1243" class="img_ev3q"></p><p><strong>Pre-Commit phase</strong>:
At this stage we can have a failure in the swap contract or in the token contract only due to the lack of gas.  To solve this problem we can use gas reservation as follows:</p><ul><li>The swap contract receives the information about error in its <code>handle_signal</code>;</li><li>Using gas reservation (so, it’s necessary to care about gas reservations before), the swap contract sends a message to itself to restart the transaction from the second phase. (The same logic can also be used in the <code>preparation phase</code>).</li></ul><p><img loading="lazy" alt="img alt" src="/assets/images/3.precommit-34c9c8365a72ba6d1120adaabc83f5bc.png#gh-light-mode-only" width="1596" height="1173" class="img_ev3q">
<img loading="lazy" alt="img alt" src="/assets/images/3.precommit-dark-095ce42a0c8bdf868c54dc5ff26fb736.png#gh-dark-mode-only" width="1596" height="1173" class="img_ev3q"></p><p><strong>Commit phase</strong>:
As in the previous stage we can have a failure only due to the lack of gas. Here it is not so critical, since at this stage all participants can commit themselves.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="saga-pattern">Saga pattern<a href="#saga-pattern" class="hash-link" aria-label="Direct link to Saga pattern" title="Direct link to Saga pattern">​</a></h2><p><strong>Theory</strong>:
A <code>saga</code> is a sequence of local transactions. Each local transaction updates the database and publishes a message or event to trigger the next local transaction in the saga. If a local transaction fails because it violates a business rule then the saga executes a series of compensating transactions that undo the changes that were made by the preceding local transactions. Thus, Saga consists of multiple steps whereas <code>2PC</code> acts like a single request.
There are two ways of coordination sagas:</p><ul><li><code>Choreography</code> - each local transaction publishes domain events that trigger local transactions in other services;</li><li><code>Orchestration</code> - an orchestrator (object) tells the participants what local transactions to execute.</li></ul><p>We will consider the <code>orchestration based Saga</code> where there would be an orchestrator (swap contract) to manage the entire operation from one center.</p><p>The swap operation consists of the following steps:</p><ol><li>Swap contract receives a message to exchange tokens in the liquidity pool. So, it must transfer tokens A from the account to its address and then transfer tokens B to the user.</li><li>It creates the first task: transfer tokens from the user to the swap contract. It also creates a compensating transaction for the first task: transfer tokens from the swap contract back to the user. The second task is to transfer tokens from the swap contract to the user.</li><li>It starts executing the first task. If the execution fails, it cancels the transaction. If it’s successful, the swap contract executes the second task;</li><li>If the execution of the second task is successful, the transaction is completed. Otherwise, the swap contract executes the compensation transaction for the first task.</li></ol><p><img loading="lazy" alt="img alt" src="/assets/images/saga-5c35daeb0e688d4cb4287c01b1ce3586.png#gh-light-mode-only" width="1500" height="397" class="img_ev3q">
<img loading="lazy" alt="img alt" src="/assets/images/Saga-dark-15232e7482a7f2265edbc8843c4969ed.png#gh-dark-mode-only" width="1500" height="397" class="img_ev3q"></p><p>It is important to note that compensatory transactions should not fail due to any logical error. They can only fall due to lack of gas. If this happens, then you need to restart the transaction again or use the gas reservation. The <code>idempotency</code> of the token contract guarantees that the transaction will be completed to the end without any duplicate transactions.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/gear-tech/wiki/edit/master/docs/developing-contracts/distributed_transactions.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developing-contracts/delayed-messages"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Delayed Messages</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developing-contracts/system-signals"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">System Signals</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#splitting-a-token-swap-transaction-into-3-separate-transactions" class="table-of-contents__link toc-highlight">Splitting a token swap transaction into 3 separate transactions</a></li><li><a href="#two-phase-commit-protocol" class="table-of-contents__link toc-highlight">Two phase commit protocol</a></li><li><a href="#three-phase-commit-protocol" class="table-of-contents__link toc-highlight">Three phase commit protocol.</a></li><li><a href="#saga-pattern" class="table-of-contents__link toc-highlight">Saga pattern</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.6ab75420.js"></script>
<script src="/assets/js/main.afedc896.js"></script>
</body>
</html>