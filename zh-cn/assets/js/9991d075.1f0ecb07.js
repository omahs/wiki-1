"use strict";(self.webpackChunkdocs_website=self.webpackChunkdocs_website||[]).push([[5344],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>g});var r=n(7294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,s=function(e,t){if(null==e)return{};var n,r,s={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var l=r.createContext({}),m=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=m(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,s=e.mdxType,a=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=m(n),g=s,d=u["".concat(l,".").concat(g)]||u[g]||p[g]||a;return n?r.createElement(d,o(o({ref:t},c),{},{components:n})):r.createElement(d,o({ref:t},c))}));function g(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var a=n.length,o=new Array(a);o[0]=u;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:s,o[1]=i;for(var m=2;m<a;m++)o[m]=n[m];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},7794:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>m});var r=n(7462),s=(n(7294),n(3905));const a={sidebar_label:"System Signals",sidebar_position:10},o="System signals",i={unversionedId:"developing-contracts/system-signals",id:"developing-contracts/system-signals",title:"System signals",description:"The Gear Protocol ensures system and program's state consistency via introducing special handling mechanisms for potential issues and corner cases.",source:"@site/docs/developing-contracts/system-signals.md",sourceDirName:"developing-contracts",slug:"/developing-contracts/system-signals",permalink:"/zh-cn/docs/developing-contracts/system-signals",draft:!1,editUrl:"https://github.com/gear-tech/wiki/edit/master/docs/developing-contracts/system-signals.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_label:"System Signals",sidebar_position:10},sidebar:"tutorialSidebar",previous:{title:"\u4e00\u81f4\u6027\u548c\u53ef\u9760\u6027",permalink:"/zh-cn/docs/developing-contracts/distributed_transactions"},next:{title:"Testing with gtest",permalink:"/zh-cn/docs/developing-contracts/testing-gtest"}},l={},m=[],c={toc:m};function p(e){let{components:t,...n}=e;return(0,s.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"system-signals"},"System signals"),(0,s.kt)("p",null,"The Gear Protocol ensures system and program's state consistency via introducing special handling mechanisms for potential issues and corner cases."),(0,s.kt)("p",null,"Gear actors have three common entry points - ",(0,s.kt)("inlineCode",{parentName:"p"},"init"),", ",(0,s.kt)("inlineCode",{parentName:"p"},"handle"),", ",(0,s.kt)("inlineCode",{parentName:"p"},"handle_reply"),". Another special system entry point introduced by the Gear Protocol is ",(0,s.kt)("inlineCode",{parentName:"p"},"handle_signal"),". It allows the system to communicate with programs if it is necessary to notify (signal) that some event related to the program's messages has happened. Only the system (Gear node runtime) can send signal messages to a program."),(0,s.kt)("p",null,"First of all, it can be useful to free up resources occupied by the program. A custom async logic in Gear implies storing ",(0,s.kt)("inlineCode",{parentName:"p"},"Futures")," in a program's memory. The execution context of ",(0,s.kt)("inlineCode",{parentName:"p"},"Futures")," can occupy some significant amount of memory in the case of many futures. When a program sends a message and waits for a reply to be woken, the reply can not be received. So there might be the case that if the initial message in the waitlist runs out of gas or the gas amount is not enough to properly finish the execution, the program\u2019s state will be rolled back and ",(0,s.kt)("inlineCode",{parentName:"p"},"Future")," will never be freed."),(0,s.kt)("p",null,"In this case, ",(0,s.kt)("inlineCode",{parentName:"p"},"Futures")," remain in memory pages forever. Other messages are not aware of ",(0,s.kt)("inlineCode",{parentName:"p"},"Futures")," associated with other messages. Over time, ",(0,s.kt)("inlineCode",{parentName:"p"},"Futures")," accumulate in the program's memory so eventually a large amount of Futures limits the max amount of space the program can use."),(0,s.kt)("p",null,"In case a message has been removed from the waitlist due to gas constraints, the system sends a system message (signal) that is baked by an amount of ",(0,s.kt)("a",{parentName:"p",href:"/zh-cn/docs/developing-contracts/gas-reservation"},"reserved gas"),", which informs the program that it\u2019s message was removed from the waitlist. Based on this info, a program can clean up its used system resources (",(0,s.kt)("inlineCode",{parentName:"p"},"Futures"),")."),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"gstd")," library provides a separate function for reserving gas specifically for system signal messages. It cannot be used for sending other regular cross-actor messages:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-rust"},'exec::system_reserve_gas(1_000_000_000).expect("Error during system gas reservation");\n')),(0,s.kt)("p",null,"If a signal message appears, it uses gas specifically reserved for such kinds of messages. If no gas has been reserved for system messages, they are just skipped and the program will not receive them."),(0,s.kt)("p",null,"If gas has been reserved but no system messages occur during the current execution, then this gas returns back from where it was taken. The same relates to gas reserved for non-system messages - gas returns back after a defined number of blocks or by the program\u2019s command."),(0,s.kt)("p",null,"It can be useful for a developer when writing communication between programs. Developer can define ",(0,s.kt)("inlineCode",{parentName:"p"},"my_handle_signal")," function and implement some logic there. For example, ",(0,s.kt)("inlineCode",{parentName:"p"},"Program A")," sent a message to ",(0,s.kt)("inlineCode",{parentName:"p"},"Program B"),". ",(0,s.kt)("inlineCode",{parentName:"p"},"Program A")," is waiting for a reply from ",(0,s.kt)("inlineCode",{parentName:"p"},"Program B")," but ",(0,s.kt)("inlineCode",{parentName:"p"},"Program B")," runs out of gas. The current execution will be interrupted, but the system will send a signal to ",(0,s.kt)("inlineCode",{parentName:"p"},"Program A")," and indicates the message identifier during which the execution was interrupted.\nSo, ",(0,s.kt)("inlineCode",{parentName:"p"},"Program A")," sends a message and saves the message identifier:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-rust"},'exec::system_reserve_gas(2_000_000_000).expect("Error during system gas reservation");\nlet result = msg::send_for_reply(address, payload, value);\n\nlet (msg_id, msg_future) = if let Ok(msg_future) = result {\n    (msg_future.waiting_reply_to, msg_future)\n} else {\n    // handle the error here\n};\n\n// save the `msg_id` in program state\nunsafe { STATE.msg_id == msg::id() };\n\nlet reply = msg_future.await;\n')),(0,s.kt)("p",null,"The execution fails in ",(0,s.kt)("inlineCode",{parentName:"p"},"Program B"),", and ",(0,s.kt)("inlineCode",{parentName:"p"},"Program A")," receives a signal:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-rust"},'#[no_mangle]\nextern "C" fn my_handle_signal() {\n    if unsafe { STATE.msg_id == msg::signal_from() } {\n        // write logic here\n    }\n}\n')),(0,s.kt)("p",null,"However, it is important to understand that the execution of ",(0,s.kt)("inlineCode",{parentName:"p"},"my_handle_signal")," should not be long and should not consume a lot of gas. It can be used for tracking failures during the transaction. The program can use the information about failures the next time it is executed."),(0,s.kt)("p",null,"For programs written using the Gear Protocol's ",(0,s.kt)("inlineCode",{parentName:"p"},"gstd")," library, such signals can be sent to programs automatically under the hood when applicable. If a smart contract developer implements a program using ",(0,s.kt)("inlineCode",{parentName:"p"},"gcore")," or Gear's syscalls, then such signals should be considered in the program's code explicitly."))}p.isMDXComponent=!0}}]);